
# ██████╗░░█████╗░██████╗░██╗░█████╗░░░░░░░░█████╗░██╗░░░░░██╗███████╗███╗░░██╗████████╗
# ██╔══██╗██╔══██╗██╔══██╗██║██╔══██╗░░░░░░██╔══██╗██║░░░░░██║██╔════╝████╗░██║╚══██╔══╝
# ██████╔╝███████║██║░░██║██║██║░░██║█████╗██║░░╚═╝██║░░░░░██║█████╗░░██╔██╗██║░░░██║░░░
# ██╔══██╗██╔══██║██║░░██║██║██║░░██║╚════╝██║░░██╗██║░░░░░██║██╔══╝░░██║╚████║░░░██║░░░
# ██║░░██║██║░░██║██████╔╝██║╚█████╔╝░░░░░░╚█████╔╝███████╗██║███████╗██║░╚███║░░░██║░░░
# ╚═╝░░╚═╝╚═╝░░╚═╝╚═════╝░╚═╝░╚════╝░░░░░░░░╚════╝░╚══════╝╚═╝╚══════╝╚═╝░░╚══╝░░░╚═╝░░░
#                                                                       ░░                      
#                                                                       ▒▒                      
#                                                                         ▒▒                    
#                                                                         ▒▒                    
#                                                                           ▒▒                  
#                                                                           ▒▒                  
#                                                                             ▒▒                
#                                                                             ▒▒                
#                                                                               ▒▒              
#                                                                                 ░░            
#                                                                                 ▒▒            
#                     ████████▓▓████████████▓▓██▓▓██████████████▓▓▓▓██████▓▓██      ▒▒          
#                   ██░░░░░░░░░░░░░░░░░░░░░░  ░░  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░██    ░░          
#                   ██░░██▓▓██▒▒████████████▒▒██████████████▓▓▓▓████████▒▒▓▓░░██      ░░        
#                   ██░░██                                                ██░░██      ░░        
#                   ██████                                                ██▓▓██      ░░██      
#                 ██  ░░░░██                                            ██░░░░░░██    ██░░██    
#   ▓▓▓▓▓▓░░░░░░▓▓██▓▓██▓▓██▓▓░░░░▓▓░░▓▓▓▓▓▓░░▓▓▓▓░░░░░░▓▓▓▓▓▓░░▓▓░░██▓▓██▓▓██▒▒██▓▓████████████
# ██▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒
# ██▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓
# ██▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓
# ██▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓
# ██▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓
# ██▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒████████▒▒▒▒▒▒████████▒▒▒▒▒▒████████▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▓▓▓▓▓▓
# ██▓▓▒▒▒▒▒▒▒▒▓▓██░░░░░░██▓▓▓▓██░░░░░░░░██▓▓██░░░░░░░░██▓▓██░░░░░░░░██▓▓▓▓██░░░░░░██▓▓▓▓▓▓▓▓▓▓▓▓
# ██▓▓▓▓████▓▓▓▓██░░░░░░██▓▓▓▓██░░░░░░░░██▓▓██░░░░░░░░██▓▓██░░░░░░░░██▓▓▓▓██░░░░░░██▓▓▓▓████▓▓▓▓
# ██▓▓██░░░░████████████████████████████████████████████████████████████████████████████░░░░██▓▓
# ██████░░░░██▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██░░░░████
# ██▓▓▒▒████▒▒▒▒▓▓████████▓▓▒▒▒▒▒▒▒▒▒▒████████████████████████▒▒▒▒▒▒▒▒▒▒▓▓████████▓▓▒▒▓▓████▓▓▓▓
# ██▒▒▒▒▒▒▒▒▓▓████░░░░░░░░████▒▒▒▒▒▒▓▓██░░░░░░░░░░░░░░░░░░░░██▓▓▒▒▒▒▓▓████░░░░░░░░████▓▓▓▓▓▓▓▓▓▓
# ██▒▒▒▒▒▒▒▒▓▓░░░░░░░░░░░░░░░░██▓▓▒▒▓▓██░░██▓▓▓▓░░░░██████░░██▓▓▒▒▓▓██░░░░░░░░░░░░░░░░██▓▓▒▒▓▓▓▓
# ██▒▒▒▒▒▒▓▓░░░░░░▓▓▓▓▒▒██░░░░░░██▒▒▓▓██░░░░▒▒░░░░░░░░░░░░░░██▓▓▒▒██░░░░░░▓▓████▓▓░░░░░░██▒▒▓▓▓▓
# ██▒▒▒▒▓▓██░░░░██▓▓▓▓▓▓▓▓██░░░░██▓▓▓▓██░░████████████████░░██▓▓▓▓██░░░░██▓▓▓▓▓▓▓▓██░░░░██▓▓▓▓▓▓
# ██▒▒▒▒██░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░▒▒██▓▓██░░██░░░░░░░░░░░░██░░██▓▓██░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░▒▒██▓▓▓▓
# ██▒▒▒▒██░░░░██▓▓▓▓▓▓▓▓▓▓▓▓██░░░░██▓▓██░░██░░██░░░░▓▓░░██░░██▓▓██░░░░██▓▓▓▓▓▓▓▓▓▓▓▓██░░░░██▓▓▓▓
# ██▒▒▒▒██░░░░██▓▓▓▓▓▓▓▓▓▓▓▓██░░░░██▓▓██░░██░░▒▒░░▒▒▒▒▒▒██░░██▓▓██░░░░██▓▓▓▓▓▓▓▓▓▓▓▓██░░░░██▓▓▓▓
# ██▒▒▒▒██░░░░██▓▓▓▓▓▓▓▓▓▓▓▓██░░░░██▓▓██░░████████████████░░██▓▓██░░░░██▓▓▓▓▓▓▓▓▓▓▓▓██░░░░██▓▓▓▓
# ██▒▒▒▒▓▓██░░░░██▓▓▓▓▓▓▓▓██░░░░██▓▓▓▓██░░░░░░░░░░░░░░░░░░░░██▓▓▓▓██░░░░██▓▓▓▓▓▓▓▓██░░░░██▓▓▓▓▓▓
# ██▒▒▒▒▓▓██░░░░░░████████░░░░░░██▓▓▓▓██████████▓▓████████████▓▓▒▒██░░░░░░████████░░░░░░██▓▓▓▓▓▓
# ██▒▒▒▒▒▒▓▓██░░░░░░░░░░░░░░░░▓▓▓▓▓▓██░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▓▓▒▒▒▒██░░░░░░░░░░░░░░░░██▓▓▒▒▓▓▓▓
# ██▒▒▒▒▒▒▒▒▓▓▓▓▓▓░░░░░░░░▓▓▓▓▓▓▒▒▓▓██▓▓████▓▓▓▓████████████▓▓██▒▒▒▒▓▓▓▓▓▓░░░░░░░░▓▓██▓▓▒▒▒▒▓▓▓▓
# ██▒▒▒▒▒▒▒▒▒▒▓▓▓▓████████▓▓▓▓▒▒▒▒▓▓██░░░░░░░░░░░░░░░░░░░░░░░░██▓▓▒▒▒▒▓▓▓▓████████▓▓▓▓▒▒▒▒▒▒▓▓▓▓
# ██▓▓▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▓▓██▒▒░░░░░░░░░░░░░░░░░░░░▒▒██▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▓▓▓▓
# ██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
#   ████████████████████████████████████████████████████████████████████████████████████████████
                                                                                              
# ▒▒░░▒▒▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
# ▒▒░░▒▒░░░░░░░░░░░░░░░░▒▒░░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒▒░░▒▒▒▒░░░░

import socket
import pprint
import pickle
import threading
import wave
import pyaudio
import time
import queue
import os
import struct
import multiprocessing

# --- TCP Connection Details ---
HOST = '127.0.0.1' # This is the server's IP Address
PORT = 3004  # This is the server's Port 

# --- Menu Options provided to User ---
menu_options = {
    "P": "Pause",
    "R": "Restart",
    "C": "Change Station",
    "X": "Exit",
}


# --- Function
def TCP_Socket_Client_to_Server():

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect((HOST, PORT))
        num = 1
        string = str(num)
        s.send(string.encode())
        data = s.recv(4096)  
        station_list = pickle.loads(data)
        return station_list


station_list = TCP_Socket_Client_to_Server()
numberOfStation = station_list["site_info"]["radio_stn_count"]


def SiteGreetings():
    print("======================")
    print("Welcome to", station_list["site_info"]["site_name"])
    print("======================")


def StationListGreetings():
    print(
        "We have",
        station_list["site_info"]["radio_stn_count"],
        "station(s) available for you!",
    )
    print(
        station_list["station1"]["radio_stn_number"],
        "-",
        station_list["station1"]["radio_stn_name"],
    )
    print("Address:", station_list["station1"]["multicast_address"])
    print("Data Port:", station_list["station1"]["data_port"])
    print("Info Port:", station_list["station1"]["info_port"])
    print("BitRate:", station_list["station1"]["bit_rate"])
    print("----------------------")
    print(
        station_list["station2"]["radio_stn_number"],
        "-",
        station_list["station2"]["radio_stn_name"],
    )
    print("Address:", station_list["station2"]["multicast_address"])
    print("Data Port:", station_list["station2"]["data_port"])
    print("Info Port:", station_list["station2"]["info_port"])
    print("BitRate:", station_list["station2"]["bit_rate"])


def printMenu():
    for i in menu_options.keys():
        print(i, "-->", menu_options[i])


# ------------- UDP ---------------------

#====== STATION 1 VARIABLES ========
MCAST_GRP_S1 = station_list["station1"]["multicast_address"]
MCAST_PORT_S1 = station_list["station1"]["data_port"]
MCAST_INFO_PORT_S1 = station_list["station1"]["info_port"]

#====== STATION 2 VARIABLES==========
MCAST_GRP_S2 = station_list["station2"]["multicast_address"]
MCAST_PORT_S2 = station_list["station2"]["data_port"]
MCAST_INFO_PORT_S2 = station_list["station2"]["info_port"]

q = queue.Queue(maxsize=20000)

def audio_stream_UDP(MCAST_GRP, MCAST_PORT):
    BUFF_SIZE = 40960
    # Set up UDP socket
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    # Group to MULTICAST IP
    group = socket.inet_aton(MCAST_GRP)
    mreq = struct.pack('4sL', group, socket.INADDR_ANY)
    # Socket operations to make request from Multicast IP
    client_socket.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP, mreq)
    # Socket operations set to re-use the address
    client_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    # Bind to the desired station PORT
    client_socket.bind(('', MCAST_PORT))
    #Set up pyaudio to stream "write" audio
    p = pyaudio.PyAudio()
    CHUNK = 10240
    stream = p.open(format=p.get_format_from_width(2),
					channels=2,
					rate=44100,
					output=True,
					frames_per_buffer=CHUNK)					

    #Define audio data to recieve and put frame in que
    def getAudioData():
        while True:
            frame,_= client_socket.recvfrom(BUFF_SIZE)
            q.put(frame)
    # Start the thread of getAudiodata() for queing concurrently
    ta = threading.Thread(target=getAudioData)
    ta.start()
    time.sleep(0.0175)
    print('Now Playing...')
    # Stream the frame from the queue
    while True:
        frame = q.get()
        stream.write(frame)

#----Information Stream---------

def info_stream_UDP(MCAST_GRP, MCAST_INFO_PORT):
    BUFF_SIZE = 40960
    # UDP socket with same MULTICAST IP, but different PORT
    info_client_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    group = socket.inet_aton(MCAST_GRP)
    mreq = struct.pack('4sL', group, socket.INADDR_ANY)
    info_client_socket.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP, mreq)
    info_client_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    info_client_socket.bind(('', MCAST_INFO_PORT))
    def getInfo():
        # Here we recieve dictionary in pickled form so we extract it to frame
        while True:          
            frameinfo,_= info_client_socket.recvfrom(BUFF_SIZE)
            new_frame = pickle.loads(frameinfo)
            # Print the information
            print("--------Now Playing--------")
            if len(new_frame.keys()) == 6:
                print("Sr ",new_frame['Song Name Size'])
                print("Song Title:      ",new_frame['title'])
                print("Time Remaining:  ",new_frame['Time Remaining'])
                print("Filesize:        ",new_frame['Filesize'])
                print("Next Song Size   ",new_frame['Next Song Size'])
                print("Next Song Title  ",new_frame['Next Song Title'])
            elif len(new_frame.keys()) == 4:
                print("Song Name Size:  ",new_frame['size_title'])
                print("Song Title:      ",new_frame['title'])
                print("Time Remaining:  ",new_frame['Time Remaining'])
                print("Filesize:        ",new_frame['filesize'])
            print("---------------------------")
    # Thread to getinfo()
    ti = threading.Thread(target=getInfo, args=())
    ti.start()
    time.sleep(0.0175)

# Function for Station 1 and 2 where Port and IP is used from recieved greetings
def Station1_get_audio():
    print("Station 1 working")
    audio_stream_UDP(MCAST_GRP_S1, MCAST_PORT_S1)


def Station1_get_info():
    print("Station 1 Info Coming")
    info_stream_UDP(MCAST_GRP_S1, MCAST_INFO_PORT_S1)


def Station2_get_audio():
    print("Station 2 chalu")
    audio_stream_UDP(MCAST_GRP_S2, MCAST_PORT_S2)


def Station2_get_info():
    print("Station 2 Info Coming")
    info_stream_UDP(MCAST_GRP_S2, MCAST_INFO_PORT_S2)

global Station1
global Station2

# Function to terminate Station thread
def Station1Close():
    Station1_get_audio_thread.terminate()
    Station1_get_audio_thread.join()
    Station1_get_info_thread.terminate()
    Station1_get_info_thread.join()

    
def Station2Close():
    Station2_get_audio_thread.terminate()
    Station2_get_audio_thread.join()
    Station2_get_info_thread.terminate()
    Station2_get_info_thread.join()

# Input menu for P,R,C,X
def UserInputMenu():
    printMenu()
    while True:   
        user_input = input()
        if user_input == "P":
            Station1 = False
            Station2 = False
            print("Pausing Stream")
            if Station1_get_audio_thread.is_alive():
                # If the Station is active we terminate thread to pause
                Station1Close()
                Station1 = True
            elif Station2_get_audio_thread.is_alive():
                Station2Close()
                Station2 = True
        elif user_input == "R":
            print("Restarting Stream")
            if Station1:
                # We restart the closed Stream from where we get the Station = True
                Station1_get_audio_thread.join()
                Station1_get_info_thread.join()
            elif Station2:
                Station2_get_audio_thread.join()
                Station2_get_info_thread.join()

        elif user_input == "C":
            # Station Closed and the else condition will send list to connect again
            if Station1_get_audio_thread.is_alive():
                print("Station1 is alive, closing it")
                Station1Close()
            elif Station2_get_audio_thread.is_alive():
                print("Station2 is alive, closing it")
                Station2Close()
            else:
                ("You are not connected to a Station right Now")
            print("What station do you want to connect to?")
            # Sent again to reconnect to the Station
            StationListGreetings()
            UserChooseStation(numberOfStation)

        elif user_input == "X":
            print("Exiting from Program")
            # The Threads are terminated to disconnect from station and we exit
            if Station1_get_audio_thread.is_alive():
                print("Station1 is alive, closing it")
                Station1Close()

            elif Station2_get_audio_thread.is_alive():
                print("Station2 is alive, closing it")
                Station2Close()

            exit(1)
        else:
            print("Invalid Option in Menu")
            
# Threads are created using multiprocessing for easy termination
Station1_get_audio_thread = multiprocessing.Process(target=Station1_get_audio)
Station1_get_info_thread = multiprocessing.Process(target=Station1_get_info)
Station2_get_audio_thread = multiprocessing.Process(target=Station2_get_audio)
Station2_get_info_thread = multiprocessing.Process(target=Station2_get_info)

def UserChooseStation(numberOfStation):
    # User input is taken to connect to which station
    user_input = int(input("Enter your Station Number: "))
    if user_input in range(1, numberOfStation + 1):
        print("You have chosen a valid Station!")
        if user_input == 1:
            # We connect station 1 here
            if Station1_get_audio_thread.is_alive():
                Station1Close()
            # The threads of the Stations are started
            Station1_get_audio_thread.start()
            Station1_get_info_thread.start()

        elif user_input == 2:
            if Station2_get_audio_thread.is_alive():
                Station2Close()
            Station2_get_audio_thread.start()
            Station2_get_info_thread.start()
    else:
        print("Error: Enter a Valid Number!")


SiteGreetings()
StationListGreetings()
UserChooseStation(numberOfStation)
UserInputMenu()
